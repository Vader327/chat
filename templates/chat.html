<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
  </head>
  
  <body>
    <h1>Chat</h1>

    <div class="messages"></div>
    <p id="typingStatus"></p>

    <form action="/chat" method="POST" id="form" onsubmit="return submitForm(event)">
      <textarea onkeydown="submitFormOnEnterPress(event)" id="inputField" placeholder="Message"></textarea>
      <input type="submit" />
    </form>

    <br /><br />

    <b>Room Name: </b> <p>{{ data.room_name }}</p>
    <b>Room Code: </b> <p>{{ data.room }}</p>

    <div class="participants">
      <b>Participants</b>

      {% for user in data.participants %}
        <p>{{ user }}</p>
      {% endfor %}
    </div>
    
    <br>

    <b>Invite Link:</b>
    <p id="invite_link"></p>
    
    <br><br>
    
    <button onclick="leave()">
      Leave
    </button>

    <script>
      console.log(window.location.href);
      var socket = io.connect(window.location.href);

      $("#invite_link").text(window.location.origin + '/invite?code={{ data.room }}')

      function submitFormOnEnterPress(e) {
        if(e.which == 13 && !e.shiftKey) { 
          submitForm(e)
        }
      }

      socket.on("connect", () => {
        socket.emit("join");
      });

      function submitForm(e){
        e.preventDefault();
        let message = $("#inputField").val();

        if(message.trim() != ""){
          socket.emit("send message", {
            username: "{{ data.username }}",
            message: message
          });

          $("#inputField").val("").focus();
        }
      }
            
      socket.on("receive message", (msg)=>{
        if(msg.username == '{{ data.username }}'){
          $(".messages").append('<div style="white-space: pre-wrap"><b>' + msg.username + ":</b> " + msg.message + "</div>");
        }
        else{
          $(".messages").append('<div style="white-space: pre-wrap;"><b>' + msg.username + ":</b> " + msg.message + "</div>");
        }
      });

      socket.on("status", (msg)=>{
        if(msg.type == 'join'){
          $(".messages").append('<div><b>' + msg.username + " has entered the room.</b></div>");

          pariticpants_list = []
          for(var element of document.getElementsByClassName('participants')[0].children) {
            pariticpants_list.push(element.innerText)
          }
          if(!pariticpants_list.includes(msg.username)){
            $(".participants").append('<div><p>' + msg.username + "</p></div>");
          }
        }
        
        else if(msg.type == 'leave'){
          $(".messages").append('<div><b>' + msg.username + " has left the room.</b></div>");
        }

        else if(msg.type == 'typing' && msg.username != '{{ data.username }}'){
          if(msg.typing){
           $('#typingStatus').text(msg.username + " is typing...")
          }
          else{
            $('#typingStatus').text("")
          }
          //$("div.messages").append('<div><b>' + msg.username + " has left the room.</b></div>");
        }
      });

      
      function leave(){
        socket.emit('leave')
        socket.disconnect()
        window.location = window.location.href.replace('/chat', '')
      }

      var timeout = null;
      $("#inputField").on("input", function(){
        socket.emit("typing_status", {'typing': true});
        
        if (timeout) {
          clearTimeout(timeout);
        }
        timeout = setTimeout(function () {
          socket.emit("typing_status", {'typing': false});
        }, 800);
        
      });
    </script>
  </body>
</html>
