<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <style>
      body{
        font-family: 'Poppins';
      }

      .main{
        display: flex;
        width: 100%;
      }

      .info_bar{
        width: 30%;
        background-color: #f1f1f1;
        margin-left: 10px;
      }

      .main_message_view{
        width: 100%;
      }

      .messages{
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .message_container{
        width: 100%
      }

      .message{
        background-color: #eaeaea;
        margin-bottom: 10px;
        float: left;
        padding: 5px;
        padding-left: 10px;
        padding-right: 10px;
        border-radius: 50px;
        word-wrap: break-word;
      }
      .message p{
        color: black;
        margin: 0px;
      }

      .from_user{
        float: right;
        background-color: #1c77ff;
      }
      .from_user p{
        color: white;
      }
    </style>
  </head>
  
  <body>
    <h1>Chat</h1>

    <div class="main">
      <div class="main_message_view">
        <div class="messages">
          <div class="message_container">
            <div class="message from_user">
              <p>
                Hello
                Hi
              </p>
            </div>
          </div>

          <div class="message_container">
            <div class="message">
              <p>Hey</p>
            </div>
          </div>
        </div>

        <p id="typingStatus"></p>


        <form action="/chat" method="POST" id="form" onsubmit="return submitForm(event)">
          <textarea onkeydown="submitFormOnEnterPress(event)" id="inputField" placeholder="Message"></textarea>
          <input type="submit" />
        </form>
      </div>

      <div class="info_bar">
        <b>Room Name: </b> <p>{{ data.room_name }}</p>
        <b>Room Code: </b> <p>{{ data.room }}</p>

        <div class="participants">
          <b>Participants</b>

          {% for user in data.participants %}
            <p>{{ user }}</p>
          {% endfor %}
        </div>
        
        <br>

        <b>Invite Link:</b>
        <p id="invite_link"></p>
        
        <br><br>
        
        <button onclick="leave()">
          Leave
        </button>
      </div>
    </div>

    <script>
      console.log(window.location.href);
      var socket = io.connect(window.location.href);

      $("#invite_link").text(window.location.origin + '/invite?code={{ data.room }}')

      function submitFormOnEnterPress(e) {
        if(e.which == 13 && !e.shiftKey) { 
          submitForm(e)
        }
      }

      socket.on("connect", () => {
        socket.emit("join");
      });

      function submitForm(e){
        e.preventDefault();
        let message = $("#inputField").val();

        if(message.trim() != ""){
          socket.emit("send message", {
            username: "{{ data.username }}",
            message: message
          });

          $("#inputField").val("").focus();
        }
      }
            
      socket.on("receive message", (msg)=>{
        message = msg.message.replace(/(?:\r\n|\r|\n)/g, '<br>');

        if(msg.username == '{{ data.username }}'){
          $(".messages").append('<div class="message_container"><div class="message from_user"><p>' + message + "</p></div></div>");          
        }
        else{
          $(".messages").append('<div class="message_container"><div class="message"><p>' + message + "</p></div></div>");
        }
      });

      socket.on("status", (msg)=>{
        if(msg.type == 'join'){
          $(".messages").append('<div><b>' + msg.username + " has entered the room.</b></div>");

          pariticpants_list = []
          for(var element of document.getElementsByClassName('participants')[0].children) {
            pariticpants_list.push(element.innerText)
          }
          if(!pariticpants_list.includes(msg.username)){
            $(".participants").append('<div><p>' + msg.username + "</p></div>");
          }
        }
        
        else if(msg.type == 'leave'){
          $(".messages").append('<div><b>' + msg.username + " has left the room.</b></div>");
        }

        else if(msg.type == 'typing' && msg.username != '{{ data.username }}'){
          if(msg.typing){
           $('#typingStatus').text(msg.username + " is typing...")
          }
          else{
            $('#typingStatus').text("")
          }
        }
      });

      
      function leave(){
        socket.emit('leave')
        socket.disconnect()
        window.location = window.location.href.replace('/chat', '')
      }

      var timeout = null;
      $("#inputField").on("input", function(){
        socket.emit("typing_status", {'typing': true});
        
        if (timeout) {
          clearTimeout(timeout);
        }
        timeout = setTimeout(function () {
          socket.emit("typing_status", {'typing': false});
        }, 800);
        
      });
    </script>
  </body>
</html>
